# Модуль reports

## Функция `get_spending_by_category`

Анализирует траты по указанной категории за последние 3 месяца и сохраняет отчёт в файл.

### Синтаксис

```python
@report_to_file(default_filename="report.json")
def get_spending_by_category(
    transactions: pd.DataFrame,
    category: str,
    target_date: str = None,
    filename: str = None
) -> dict
```
В случае ошибки возвращает словарь с ключом "error".

### Особенности работы

✅ Автоматическое сохранение результатов

Результат сохраняется в:

JSON-файл (если результат — словарь/список)

Текстовый файл (для других типов данных)


✅ Гибкое именование файлов

Поддерживается:

Значение по умолчанию из декоратора

Переопределение через параметр filename

Динамические имена с {timestamp}


✅ Комплексное логирование

Логируются:

Параметры вызова функции

Критические этапы выполнения

Полные ошибки с traceback


✅ Обработка крайних случаев

Проверка обязательных колонок

Фильтрация некорректных дат

Корректная обработка отсутствия данных



### Создаём тестовый DataFrame
```markdown
data = {
    "Дата операции": ["01.11.2023", "15.11.2023", "03.12.2023"],
    "Категория": ["продукты", "ПРОДУКТЫ", "кафе"],
    "Сумма операции": [-1500, -2300, -700]
}
df = pd.DataFrame(data)
```
### Анализируем траты
```markdown
result = get_spending_by_category(
    transactions=df,
    category="Продукты",
    filename="food_spending_{timestamp}.json"
)
```
#### Требования

Python 3.8+

Pandas

Логгер (настроенный в проекте)



# Модуль services

## Функция `analyze_cashback_categories`

Анализирует категории кэшбэка за указанный месяц и год, возвращая JSON-строку с суммами кэшбэка по категориям.

### Синтаксис

```python
def analyze_cashback_categories(
    path_file: str,
    year: int,
    month: int
) -> str
```
### Особенности работы

✅ Проверка входных данных

Валидация существования файла

Проверка обязательных колонок:

Дата операции

Статус

Кэшбэк

Категория

Фильтрация некорректных дат и значений


✅ Фильтрация данных

Только операции со статусом "OK"

Только указанный месяц и год

Только положительные значения кэшбэка


✅ Логирование процесса

Запись ключевых этапов обработки

Предупреждения о проблемных данных

Детализация ошибок



✅ Обработка ошибок

Файл не найден

Отсутствуют обязательные колонки

Некорректные данные

Пустые данные

### Пример использования

```markdown
result_json = analyze_cashback_categories(
    path_file="transactions.xlsx",
    year=2023,
    month=11
)

print(result_json)
```

#### Требования к данным

Формат файла: Excel (.xlsx)

Обязательные колонки:

Дата операции (в формате, распознаваемом pandas)

Статус (должен содержать значение "OK" для успешных операций)

Кэшбэк (числовые значения)

Категория (названия категорий)


#### Логика работы

Чтение и валидация файла

Преобразование и фильтрация данных:

Корректные даты операций

Только успешные операции (Статус == "OK")

Только указанный период (месяц/год)

Группировка по категориям

Суммирование кэшбэка

Сортировка по убыванию суммы

Возврат результата в JSON-формате


#### Обрабатываемые ошибки

FileNotFoundError - файл не существует

ValueError - отсутствуют обязательные колонки

EmptyDataError - файл не содержит данных

Все прочие ошибки с записью в лог

# Модуль views

### Функция process_cards_data

Анализирует расходы по банковским картам и рассчитывает кэшбэк.

Синтаксис

```markdown
def process_cards_data(df: pd.DataFrame) -> List[Dict]
```
#### Логика работы

Извлекает последние 4 цифры номера карты

Суммирует расходы по каждой карте

Рассчитывает кэшбэк (1% от суммы расходов)

Возвращает данные по всем картам

#### Особенности

Игнорирует доходы (положительные суммы)

Округляет суммы до 2 знаков

Логирует количество обработанных карт

### Функция process_top_transactions

Выявляет N самых крупных расходных операций.

```markdown
def process_top_transactions(
    df: pd.DataFrame,
    n: int = 5
) -> List[Dict]
```

#### Логика работы

Фильтрует только расходные операции

Преобразует дату в формат DD.MM.YYYY

Выбирает N самых крупных операций

Форматирует данные для вывода

#### Особенности

Поддерживает настройку количества транзакций (параметр n)

Сохраняет все операции при одинаковых суммах (keep="all")

Логирует количество обработанных транзакций

#### Требования к данным

Для корректной работы всех функций DataFrame должен содержать следующие колонки:

Дата операции - в распознаваемом pandas формате

Номер карты - с маской ****1234

Сумма операции - отрицательные значения для расходов

Категория - название категории операции

Описание - текстовое описание операции